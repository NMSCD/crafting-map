(()=>{function v(n,t){return n.some(e=>t.some(r=>e===r))}var f=class{#t;constructor(t={}){this.#t=t}search(t){return t?(delete this.#t.clickId,this.#t.search=t,this):(delete this.#t.search,this)}clickId(t){return t?(delete this.#t.search,this.#t.clickId=t,this):(delete this.#t.clickId,this)}direction(t){return this.#t.direction=t,this}build(){return this.#t}};var{select:g,zoom:H,drag:_}=d3,V=window.innerHeight,R=window.innerWidth;function $(n){function t(e){n.select(".nodes").attr("transform",e.transform),n.select(".links").attr("transform",e.transform)}n.call(H().on("zoom",t))}function L(n,t){let e=_().on("start",i).on("drag",s);n.call(e).on("click",r);function r(o,h){delete h.fx,delete h.fy,g(this).classed("fixed",!1),t.restart()}function i(){g(this).classed("fixed",!0)}function s(o,h){h.fx=c(o.x,0,R),h.fy=c(o.y,0,V),t.restart()}function c(o,h,u){return o<h?h:o>u?u:o}}function b(n,t){function e({id:i}){let s=g(`.node[data-target="${i}"]`);s.classed("node targeted",!0);let c=s.select("text").text();t.changeConfig(new f(t.config).search(c).build())}function r(){return(i,s)=>{i.preventDefault(),e(s)}}n.on("contextmenu",r())}function C(n,t){let e=g("body").append("div").attr("id","hoverInfo").style("opacity","0").text("a simple tooltip");function r({x:d,y:a}){e.style("top",a+"px").style("left",d+10+"px"),e.style("display","block"),e.transition().duration(150).style("opacity","0.9")}function i(d,a){return d.filter(l=>v(l.connectionIdx,a.connectionIdx))}function s(d){let a=d.source.map(l=>`<div>${l.count}</div> <img src="assets/${l.image}"/>`);return a=a.join(""),a+=`<div>=  ${d.count}</div> <img src="assets/${d.image}"/>`,a}function c(d){let a=d.map(l=>s(l));return a=a.map(l=>`<div class="wrapper"> ${l} </div>`),a=a.join(""),a}let o;function h(d,a){o=setTimeout(()=>r(d),100),i(n,a).transition().duration("50").attr("stroke","#f8bc63").attr("marker-end",()=>`url(${new URL("#arrow-highlight",location)})`);let B=t.connectionsDataByIdxes(a.connectionIdx),E=c(B);e.html(E)}function u(d){i(n,d).transition().duration("50").attr("stroke","#7f7f7f").attr("marker-end",()=>`url(${new URL("#arrow-basic",location)})`),e.transition().duration(150).style("opacity","0"),e.style("display","none"),clearTimeout(o)}n.on("mouseover",function(d,a){h(d,a)}),n.on("mouseout",function(d,a){u(a)})}var{forceCenter:j,forceCollide:W,forceLink:F,forceManyBody:G,forceSimulation:P}=window.d3,m=class{#t;#e;constructor(t){this.#e=t,this.#t=U(t)}restart(){this.#t.alpha(1).restart()}resetData(t,e){this.#t.nodes(t),this.#t.force("link").links(e),this.#t.force("charge").strength(-5),this.#t.force("colide").strength(.5),this.restart()}onTick(t){this.#t.on("tick",t)}};function U({width:n,height:t,collisionRadius:e}){return P().nodes([]).force("charge",G()).force("center",j(n/2,t/2)).force("colide",W(e)).force("link",F())}var{create:Z}=d3,k=class{#t;#e;#n;#r;#o;#i;constructor(t,e){this.#t=t,this.#i=e,this.#o=new m(t),this.#o.onTick(()=>this.#c())}build(){this.#e=q(this.#t),this.#r=T(this.#t,this.#e),this.#n=D(this.#t,this.#e),$(this.#e)}#a(t){this.#n.on(".",null),this.#n.remove(),this.#n=D(this.#t,this.#e,t),L(this.#n,this.#o),b(this.#n,this.#i)}#s(t){this.#r.on(".",null),this.#r.remove(),this.#r=T(this.#t,this.#e,t),C(this.#r,this.#i)}#c(){this.#r.attr("d",t=>X(this.#t,t)),this.#n.attr("transform",t=>`translate(${t.x},${t.y})`)}get htmlEl(){return this.#e.node()}refresh(){this.#a(this.#i.nodes),this.#s(this.#i.links),this.#o.resetData(this.#i.nodes,this.#i.links)}};function q({width:n,height:t}){let e=Z("svg").attr("id","nms-graph").attr("viewBox",[0,0,n,t]);return O(e),e}function O(n){let t=n.append("defs");return t.append("marker").attr("id","arrow-basic").attr("viewBox","0 -5 10 10").attr("refX",8).attr("refY",0).attr("markerWidth",4).attr("markerHeight",4).attr("orient","auto").append("path").attr("fill","#7f7f7f").attr("d","M0,-5L10,0L0,5"),t.append("marker").attr("id","arrow-highlight").attr("viewBox","0 -5 10 10").attr("refX",8).attr("refY",0).attr("markerWidth",4).attr("markerHeight",4).attr("orient","auto").append("path").attr("fill","#f8bc63").attr("d","M0,-5L10,0L0,5"),n}function T({},n,t=[]){let e=n.select(".links");return e.empty()&&(e=n.append("g").classed("links",!0).attr("fill","none").attr("stroke-width",2)),e.selectAll("path").data(t).join("path").attr("data-target",r=>r.target).attr("stroke",()=>"#7f7f7f").attr("marker-end",()=>`url(${new URL("#arrow-basic",location)})`)}function D({iconSize:n},t,e=[]){let r=t.select(".nodes");r.empty()&&(r=t.append("g").classed("nodes",!0));let i=r.selectAll(".node").data(e).join("g").classed("node",!0).attr("data-target",o=>o.id);i.append("circle").attr("r",o=>I(o.value,n)).classed("fixed",o=>o.fx!==void 0),i.append("svg:image").attr("xlink:href",o=>`assets/${o.image}`).attr("x",n/-2).attr("y",n/-2).attr("width",n).attr("height",n);let s=i.append("text").attr("text-anchor","middle").attr("x",0).attr("y",-n/2).text(o=>o.name);s.clone(!0).attr("fill","none").attr("stroke","white").attr("stroke-width",3),s.raise();let c=i.append("text").attr("text-anchor","middle").attr("x",0).attr("y",n/2+8).text(o=>o.value+" $");return c.clone(!0).attr("fill","none").attr("stroke","white").attr("stroke-width",3),c.raise(),i}function X({iconSize:n},t){let r=Math.hypot(t.target.x-t.source.x,t.target.y-t.source.y),i=I(t.source.value,n),s=i*(t.target.x-t.source.x)/r+t.source.x,c=i*(t.target.y-t.source.y)/r+t.source.y,o=I(t.target.value,n)+2,h=o*(t.source.x-t.target.x)/r+t.target.x,u=o*(t.source.y-t.target.y)/r+t.target.y;return isNaN(s)||isNaN(c)?"":`
    M${s},${c}
    A${r},${r} 0 0 0 ${h},${u}
  `}function I(n,t){let e=Number(n)||1;return Math.log2(e)+t/2+2}var y=class{#t;#e={};#n={};#r;constructor(t){this.#t=t}refresh(t){this.#e=t,this.#n={},this.#r=void 0,this.#i(),this.#o(),this.#a()}get nodesIds(){return this.#n.nodeIds}get links(){return this.#n.links}#o(){let t=this.#e.search?.toLowerCase();if(!t)return;let e=this.#t.allNodes.filter(r=>r.name.toLowerCase().includes(t)).map(r=>r.id);this.#r=e,this.#n.nodeIds=this.#s(e)}#i(){let t=this.#e.clickId;!t||(this.#r=[t],this.#n.nodeIds=this.#s([t]))}#a(){let t=this.#r;if(!t)return;let e=this.#e.direction?"target":"source";this.#n.links=this.#t.allLinks.filter(r=>t.includes(r[e].id))}#s(t){let e=this.#t.allLinks,r=this.#e.direction?"target":"source",i=this.#e.direction?"source":"target",s=e.reduce((c,o)=>t.includes(o[r].id)&&!c.includes(o[i].id)?[...c,o[i].id]:c,[...t]);return[...new Set(s)]}};var{autoType:N,csvParse:S}=d3;function Y(n,t){return n.map((e,r)=>{let i=[];if(!e.Source_1)throw new Error("parsing error!");return i.push({id:t.get(e.Source_1).id,count:e.Count_1}),e.Source_2&&i.push({id:t.get(e.Source_2).id,count:e.Count_2}),e.Source_3&&i.push({id:t.get(e.Source_3).id,count:e.Count_3}),{source:i,targetId:t.get(e.Target).id,count:e.TargetCount,connectionIdx:r,type:e.Type}})}function J(n){let t=new Map;return n.forEach((e,r)=>{e.source.forEach(i=>{let s=`${i.id}_${e.targetId}`;t.has(s)?t.get(s).connectionIdx=[...t.get(s).connectionIdx,r]:t.set(s,{source:i.id,target:e.targetId,connectionIdx:[r]})})}),t}var x=class{#t={};#e={};#n;#r;constructor(){this.#n=new y(this)}get nodes(){let t=this.#n.nodesIds;return t?this.#t.nodes.filter(e=>t.includes(e.id)):this.#t.nodes}get links(){return this.#n.links||this.#t.links}set config(t){this.#e=t,this.#n.refresh(t)}changeConfig(t){this.config=t,this.#r(t)}config$(t){this.#r=t}get config(){return this.#e}get allNodes(){return this.#t.nodes}get allLinks(){return this.#t.links}connectionsDataByIdxes(t){return t.map(r=>this.#t.connections[r]).map(r=>({...r,...this.#t.nodes.find(i=>i.id===r.targetId),source:r.source.map(i=>({...this.#t.nodes.find(s=>s.id===i.id),...i}))}))}async fetchCSV$(){let t=await fetch("assets/data/nodes.csv"),e=await t.text(),r=K(S(e,N));t=await fetch("assets/data/connections.csv"),e=await t.text();let i=Y(S(e,N),r),s=J(i);this.#t.nodes=[...r.values()],this.#t.connections=i,this.#t.links=[...s.values()]}};function K(n){let t=new Map;return n.forEach((e,r)=>{t.set(e.Name,{name:e.Name,id:r,category:e.Category,type:e.Type,value:e.Value,image:e.Image})}),t}var Q=document.querySelector("#graph"),A=document.querySelector("ak-menu"),z=window.innerHeight,tt=window.innerWidth,M=32,et={width:tt,height:z,iconSize:M,collisionRadius:M*3},w=new x,p=new k(et,w);p.build();w.fetchCSV$().then(()=>{p.refresh()});w.config$(n=>{A.resetFilters(n),p.refresh()});A.addEventListener("filter",({detail:n})=>{w.config=new f().search(n.search).direction(n.direction).clickId(n.clickId).build(),p.refresh()});Q.append(p.htmlEl);})();
