(()=>{var p=class{#t;constructor(t={}){this.#t=t}search(t){return t?(delete this.#t.clickId,this.#t.search=t,this):(delete this.#t.search,this)}clickId(t){return t?(delete this.#t.search,this.#t.clickId=t,this):(delete this.#t.clickId,this)}direction(t){return this.#t.direction=t,this}build(){return this.#t}};var{select:S,zoom:M,drag:_}=d3,B=window.innerHeight,F=window.innerWidth;function v(n){function t(e){n.select(".nodes").attr("transform",e.transform),n.select(".links").attr("transform",e.transform),n.select(".linkHovers").attr("transform",e.transform)}n.call(M().on("zoom",t))}function T(n,t){let e=_().on("start",o).on("drag",s);n.call(e).on("click",r);function r(i,l){delete l.fx,delete l.fy,S(this).classed("fixed",!1),t.restart()}function o(){S(this).classed("fixed",!0)}function s(i,l){l.fx=a(i.x,0,F),l.fy=a(i.y,0,B),t.restart()}function a(i,l,u){return i<l?l:i>u?u:i}}function C(n,t){function e({id:o}){let s=S(`.node[data-target="${o}"]`);s.classed("node targeted",!0);let a=s.select("text").text();t.changeConfig(new p(t.searchOpts).search(a).build())}function r(){return(o,s)=>{o.preventDefault(),e(s)}}n.on("contextmenu",r())}var{forceCenter:R,forceCollide:W,forceLink:j,forceManyBody:P,forceSimulation:Z}=window.d3,g=class{#t;#e;constructor(t){this.#e=t,this.#t=q(t)}restart(){this.#t.alpha(1).restart()}resetData(t,e){this.#t.nodes(t),this.#t.force("link",j().links(e)),this.restart()}onTick(t){this.#t.on("tick",t)}onEnd(t){this.#t.on("end",t)}};function q({width:n,height:t,collisionRadius:e}){return Z().nodes([]).force("charge",P().strength(-5)).force("center",R(n/2,t/2)).force("colide",W(e).strength(.5))}function I(n,t){return n.some(e=>t.some(r=>e===r))}var{selectAll:X,select:Y}=d3;function L(n,t){let e=Y("body").append("div").attr("id","hoverInfo").style("opacity","0").text("a simple tooltip");function r({x:d,y:c}){e.style("top",c+"px").style("left",d+10+"px"),e.style("display","block"),e.transition().duration(150).style("opacity","0.9")}function o(d,c){return d.filter(h=>I(h.connectionIdx,c.connectionIdx))}function s(d){let c=d.source.map(h=>`<div>${h.count}</div> <img src="assets/${h.image}"/>`);return c=c.join(""),c+=`<div>=  ${d.count}</div> <img src="assets/${d.image}"/>`,c}function a(d){let c=d.map(h=>s(h));return c=c.map(h=>`<div class="wrapper"> ${h} </div>`),c=c.join(""),c}let i;function l(d,c){i=setTimeout(()=>r(d),100),o(n,c).classed("hover",!0);let A=t.connectionsDataByIdxes(c.connectionIdx),H=a(A);e.html(H)}function u(d){o(n,d).classed("hover",!1),e.transition().duration(150).style("opacity","0"),e.style("display","none"),clearTimeout(i)}let D=X("svg .linkHovers path");D.on("mouseover",function(d,c){l(d,c)}),D.on("mouseout",function(d,c){u(c)})}var{create:J}=d3,y=class{#t;#e;#n;#r;#s;#i;#o;constructor(t,e){this.#t=t,this.#o=e,this.#i=new g(t),this.#i.onTick(()=>this.#d()),this.#i.onEnd(()=>this.#l())}build(){this.#e=K(this.#t),v(this.#e)}#a(t){this.#n?.on(".",null),this.#n?.remove(),this.#n=U(this.#t,this.#e,t),T(this.#n,this.#i),C(this.#n,this.#o)}#c(t){this.#r?.on(".",null),this.#r?.remove(),this.#r=N(this.#t,this.#e,t,"links"),this.#s=N(this.#t,this.#e,t,"linkHovers"),L(this.#r,this.#o)}#d(){this.#r?.attr("d",t=>$(this.#t,t)),this.#s?.attr("d",t=>$(this.#t,t)),this.#n?.attr("transform",t=>`translate(${t.x},${t.y})`)}get htmlEl(){return this.#e.node()}refresh(){this.#c(this.#o.links),this.#a(this.#o.nodes),this.#i.resetData(this.#o.nodes,this.#o.links)}#l(){}};function K({width:n,height:t,curvedArrows:e}){let r=J("svg").attr("id","nms-graph").attr("viewBox",[0,0,n,t]).classed("arrows",e);return Q(r)}function Q(n){let t=n.append("defs");return t.append("marker").attr("id","arrow-basic").attr("viewBox","0 -5 10 10").attr("refX",8).attr("refY",0).attr("markerWidth",4).attr("markerHeight",4).attr("orient","auto").append("path").attr("fill","#7f7f7f").attr("d","M0,-5L10,0L0,5"),t.append("marker").attr("id","arrow-highlight").attr("viewBox","0 -5 10 10").attr("refX",8).attr("refY",0).attr("markerWidth",4).attr("markerHeight",4).attr("orient","auto").append("path").attr("fill","#f8bc63").attr("d","M0,-5L10,0L0,5"),n}function N({},n,t=[],e){let r=n.select("."+e);return r.empty()&&(r=n.append("g").classed(e,!0)),r.selectAll("path").data(t).join("path").attr("data-target",o=>o.target)}function U({iconSize:n},t,e=[]){let r=t.select(".nodes");r.empty()&&(r=t.append("g").classed("nodes",!0));let o=r.selectAll(".node").data(e).join("g").classed("node",!0).attr("data-target",i=>i.id);o.append("circle").attr("r",i=>f(i.value,n)),o.append("svg:image").attr("xlink:href",i=>`assets/${i.image}`).attr("x",n/-2).attr("y",n/-2).attr("width",n).attr("height",n);let s=o.append("text").attr("text-anchor","middle").attr("x",0).attr("y",-n/2).text(i=>i.name);s.clone(!0).attr("fill","none").attr("stroke","white").attr("stroke-width",3),s.raise();let a=o.append("text").attr("text-anchor","middle").attr("x",0).attr("y",n/2+8).text(i=>i.value+" $");return a.clone(!0).attr("fill","none").attr("stroke","white").attr("stroke-width",3),a.raise(),o}function $(n,t){return n.curvedArrows?tt(n,t):z(n,t)}function z({iconSize:n},t){let r=Math.hypot(t.target.x-t.source.x,t.target.y-t.source.y),o=f(t.source.value,n),s=o*(t.target.x-t.source.x)/r+t.source.x,a=o*(t.target.y-t.source.y)/r+t.source.y,i=f(t.target.value,n)+2,l=i*(t.source.x-t.target.x)/r+t.target.x,u=i*(t.source.y-t.target.y)/r+t.target.y;return`M${s},${a}
          ${l},${u}`}function tt({iconSize:n},t){let r=Math.hypot(t.target.x-t.source.x,t.target.y-t.source.y),o=f(t.source.value,n),s=o*(t.target.x-t.source.x)/r+t.source.x,a=o*(t.target.y-t.source.y)/r+t.source.y,i=f(t.target.value,n)+2,l=i*(t.source.x-t.target.x)/r+t.target.x,u=i*(t.source.y-t.target.y)/r+t.target.y;return isNaN(s)||isNaN(a)?"":`
    M${s},${a}
    A${r},${r} 0 0 0 ${l},${u}
  `}function f(n,t){let e=Number(n)||1;return Math.log2(e)+t/2+2}var k=class{#t;#e={};#n={};#r;constructor(t){this.#t=t}refresh(t){this.#e=t,this.#n={},this.#r=void 0,this.#i(),this.#s(),this.#o()}get nodesIds(){return this.#n.nodeIds}get links(){return this.#n.links}#s(){let t=this.#e.search?.toLowerCase();if(!t)return;let e=this.#t.allNodes.filter(r=>r.name.toLowerCase().includes(t)).map(r=>r.id);this.#r=e,this.#n.nodeIds=this.#a(e)}#i(){let t=this.#e.clickId;!t||(this.#r=[t],this.#n.nodeIds=this.#a([t]))}#o(){let t=this.#r;if(!t)return;let e=this.#e.direction?"target":"source";this.#n.links=this.#t.allLinks.filter(r=>t.includes(r[e].id))}#a(t){let e=this.#t.allLinks,r=this.#e.direction?"target":"source",o=this.#e.direction?"source":"target",s=e.reduce((a,i)=>t.includes(i[r].id)&&!a.includes(i[o].id)?[...a,i[o].id]:a,[...t]);return[...new Set(s)]}};var{autoType:E,csvParse:b}=d3;function et(n,t){return n.map((e,r)=>{let o=[];if(!e.Source_1)throw new Error("parsing error!");return o.push({id:t.get(e.Source_1).id,count:e.Count_1}),e.Source_2&&o.push({id:t.get(e.Source_2).id,count:e.Count_2}),e.Source_3&&o.push({id:t.get(e.Source_3).id,count:e.Count_3}),{source:o,targetId:t.get(e.Target).id,count:e.TargetCount,connectionIdx:r,type:e.Type}})}function nt(n,t){let e=new Map;return t.forEach((r,o)=>{r.source.forEach(s=>{let a=`${s.id}_${r.targetId}`,i=`${r.targetId}_${s.id}`;e.has(a)?e.get(a).connectionIdx=[...e.get(a).connectionIdx,o]:e.has(i)&&!n.curvedArrows?(e.get(i).connectionIdx=[...e.get(i).connectionIdx,o],e.get(i).twoWay=!0):e.set(a,{source:s.id,target:r.targetId,connectionIdx:[o]})})}),e}var x=class{constructor(t){this.config=t;this.#e=new k(this)}#t={};_searchOpts;#e;#n;get nodes(){let t=this.#e.nodesIds;return t?this.#t.nodes.filter(e=>t.includes(e.id)):this.#t.nodes}get links(){return this.#e.links||this.#t.links}set searchOpts(t){this._searchOpts=t,this.#e.refresh(t)}changeConfig(t){this.searchOpts=t,this.#n(t)}config$(t){this.#n=t}get searchOpts(){return this._searchOpts}get allNodes(){return this.#t.nodes}get allLinks(){return this.#t.links}connectionsDataByIdxes(t){return t.map(r=>this.#t.connections[r]).map(r=>({...r,...this.#t.nodes.find(o=>o.id===r.targetId),source:r.source.map(o=>({...this.#t.nodes.find(s=>s.id===o.id),...o}))}))}async fetchCSV$(){let t=await fetch("assets/data/nodes.csv"),e=await t.text(),r=rt(b(e,E));t=await fetch("assets/data/connections.csv"),e=await t.text();let o=et(b(e,E),r),s=nt(this.config,o);this.#t.nodes=[...r.values()],this.#t.connections=o,this.#t.links=[...s.values()]}};function rt(n){let t=new Map;return n.forEach((e,r)=>{t.set(e.Name,{name:e.Name,id:r,category:e.Category,type:e.Type,value:e.Value,image:e.Image})}),t}var ot=document.querySelector("#graph"),V=document.querySelector("ak-menu"),it=window.innerHeight,st=window.innerWidth,G=32,O={width:st,height:it,iconSize:G,collisionRadius:G*3,curvedArrows:!1},w=new x(O),m=new y(O,w);m.build();w.fetchCSV$().then(()=>{m.refresh()});w.config$(n=>{V.resetFilters(n),m.refresh()});V.addEventListener("filter",({detail:n})=>{w.searchOpts=new p().search(n.search).direction(n.direction).clickId(n.clickId).build(),m.refresh()});ot.append(m.htmlEl);})();
